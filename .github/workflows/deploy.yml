name: Deploy to Production

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      APP_NAME: prettyjson
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: front-end/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.23"
          cache-dependency-path: back-end/go.sum

      - name: Build frontend + backend
        run: sh ./build.sh

      - name: Show build artifacts (debug)
        run: |
          echo "Frontend dist:"
          ls -la front-end/dist 2>/dev/null || echo "No front-end/dist found — check build.sh"
          echo ""
          echo "Backend files (expect binary):"
          ls -la back-end/ | grep -E 'prettyjson|binary|dist|static|public' || echo "No obvious binary/static folder"

      - name: Deploy files via rsync
        uses: burnett01/rsync-deployments@v8
        with:
          switches: -avzr --delete
          path: ./
          remote_path: ${{ env.DEPLOY_DIR }}/
          remote_host: ${{ env.SERVER_HOST }}
          remote_user: ${{ env.SERVER_USER }}
          remote_key: ${{ secrets.DEPLOY_KEY }}
          args_append: >-
            --exclude=.git
            --exclude=.github
            --exclude=front-end/node_modules
            --exclude=front-end/src
            --exclude=front-end/public
            --exclude=front-end/*.js.map
            --exclude=back-end/*.go
            --exclude=back-end/go.*
            --exclude=**/*.md
            --exclude=build.sh
            --exclude=*.log
            --exclude=*.tmp

      - name: Restart application on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          envs: DEPLOY_DIR,APP_NAME
          script: |
            set -euo pipefail

            cd "${DEPLOY_DIR}"

            BINARY="./back-end/${APP_NAME}"

            if [ ! -x "$BINARY" ]; then
              echo "ERROR: Binary not found or not executable → $BINARY"
              ls -la back-end/ || true
              exit 1
            fi

            echo "Current running processes:"
            ps aux | grep -E "${APP_NAME}|${BINARY}" | grep -v grep || echo "No process found"

            # Graceful stop attempt (send SIGTERM, give time to shutdown cleanly)
            echo "Stopping old instance (if running)..."
            pkill -TERM -f "${APP_NAME}" || true
            sleep 4

            # Force kill if still alive
            pkill -KILL -f "${APP_NAME}" || true

            echo "Starting new version..."
            nohup "${BINARY}" >> server.log 2>&1 &

            sleep 5

            if pgrep -f "${APP_NAME}" > /dev/null; then
              echo "Success: ${APP_NAME} is running"
              tail -n 15 server.log
            else
              echo "Failed to start — check logs:"
              cat server.log || echo "No log file found"
              exit 1
            fi

            # Future systemd version (uncomment when ready):
            # sudo systemctl daemon-reload
            # sudo systemctl restart "${APP_NAME}"
            # sudo systemctl status "${APP_NAME}" --no-pager
